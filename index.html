<!DOCTYPE html>
<html>
<head>
  <title>Canvas Fingerprint Test</title>
</head>
<body>
  <canvas id="testCanvas" width="300" height="100"></canvas>
  <script>
    const canvas = document.getElementById('testCanvas');
    const ctx = canvas.getContext('2d');
    let spoofingDetected = false;

    // Draw a blue rectangle (should be pure blue if not modified)
    ctx.fillStyle = "#007FFF";  // Pure blue (0,127,255)
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw fingerprinting text on top
    ctx.font = "16px Arial";
    ctx.fillStyle = "#000";
    ctx.fillText("Fingerprint Test", 10, 50);

    // Capture the canvas output twice (to test for inconsistency)
    const snapshot1 = canvas.toDataURL();

    // Force re-read by clearing and redrawing the canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#007FFF";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.font = "16px Arial";
    ctx.fillStyle = "#000";
    ctx.fillText("Fingerprint Test", 10, 50);
    const snapshot2 = canvas.toDataURL();

    // If the snapshots differ, noise is present
    if (snapshot1 !== snapshot2) {
      spoofingDetected = true;
    }

    // Check a known pixel from the blue background
    const imageData = ctx.getImageData(5, 5, 1, 1).data;
    // Expected value for a pure blue background: [0,127,255,255]
    const expected = [0, 127, 255, 255];
    for (let i = 0; i < 4; i++) {
      if (imageData[i] !== expected[i]) {
        spoofingDetected = true;
        break;
      }
    }

    // Set the document title so Selenium can read it
    document.title = spoofingDetected ? "Spoofing Detected" : "No Spoofing";
    console.log(spoofingDetected ? "Canvas spoofing is ACTIVE." : "No canvas spoofing detected.");
  </script>
</body>
</html>
